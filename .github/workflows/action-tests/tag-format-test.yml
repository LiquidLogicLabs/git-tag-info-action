name: Action Test - Tag Format Filtering

on:
  workflow_dispatch:
  workflow_call:

jobs:
  test-tag-format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for tag testing

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build action
        run: npm run build

      - name: Test - Latest tag with X.X format
        id: format-xx
        uses: ./
        with:
          tag_name: latest
          repository: .
          tag_format: X.X
        continue-on-error: true

      - name: Verify X.X format
        if: success()
        run: |
          if [ "${{ steps.format-xx.outputs.exists }}" = "true" ]; then
            echo "✓ X.X format resolved: ${{ steps.format-xx.outputs.tag_name }}"
          else
            echo "ℹ No tags matching X.X format found"
          fi

      - name: Test - Latest tag with X.X.X format
        id: format-xxx
        uses: ./
        with:
          tag_name: latest
          repository: .
          tag_format: X.X.X
        continue-on-error: true

      - name: Verify X.X.X format
        if: success()
        run: |
          if [ "${{ steps.format-xxx.outputs.exists }}" = "true" ]; then
            echo "✓ X.X.X format resolved: ${{ steps.format-xxx.outputs.tag_name }}"
          else
            echo "ℹ No tags matching X.X.X format found"
          fi

      - name: Test - Latest tag with wildcard format
        id: format-wildcard
        uses: ./
        with:
          tag_name: latest
          repository: .
          tag_format: '*.*.*'
        continue-on-error: true

      - name: Verify wildcard format
        if: success()
        run: |
          if [ "${{ steps.format-wildcard.outputs.exists }}" = "true" ]; then
            echo "✓ Wildcard format resolved: ${{ steps.format-wildcard.outputs.tag_name }}"
          else
            echo "ℹ No tags matching wildcard format found"
          fi

      - name: Test - Latest tag with comma-separated formats
        id: format-multiple
        uses: ./
        with:
          tag_name: latest
          repository: .
          tag_format: 'X.X.X,X.X'
        continue-on-error: true

      - name: Verify multiple formats
        if: success()
        run: |
          if [ "${{ steps.format-multiple.outputs.exists }}" = "true" ]; then
            echo "✓ Multiple formats resolved: ${{ steps.format-multiple.outputs.tag_name }}"
          else
            echo "ℹ No tags matching any format found"
          fi

      - name: Test Summary
        run: |
          echo "## ✅ Tag Format Filtering Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- X.X format: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- X.X.X format: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Wildcard format: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Multiple formats: ✅" >> $GITHUB_STEP_SUMMARY

